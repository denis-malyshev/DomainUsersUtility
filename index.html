<!DOCTYPE html>
<html>
<head>
    <title>Domain users utility</title>
    <meta charset='utf-8'/>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>

    <link href="lib/css/custom.css" rel="stylesheet">
    <script type="application/javascript" src="common/utils.js"></script>

</head>
<body>

<script type="application/javascript">
    let caret = ' <span class=\'caret\'></span>';

    function updateContent() {
        let requestParams = buildRequestParams();
        listUsers(requestParams).then(function (users) {
            updateUsersTable(users, requestParams.order, requestParams.sortOrder);
        });
    }

    function selectOrder(order, value) {
        let elemId = 'orderValue';

        changeInnerHTML(elemId, value + caret);
        changeElementValue(elemId, order);
        updateContent();
    }

    function selectFindType(type, value) {
        let btnId = 'findByType';

        changeInnerHTML(btnId, value + caret);
        changeElementValue(btnId, type);
    }

    function compareByLastLogin(u1, u2) {
        return Math.sign(Date.parse(u1.lastLoginTime) - Date.parse(u2.lastLoginTime));
    }

    function updateUsersTable(users, order, sortOrder) {
        clearTable('users-table');

        if (users && users.length > 0) {
            if (order == 'lastLogin') {
                users.sort((u2, u1) => compareByLastLogin(u1, u2));

                if (sortOrder == 'DESCENDING') {
                    users.reverse();
                }
            }

            for (let i = 0; i < users.length; i++) {
                let user = users[i];
                appendRow('users-table', [user.name.givenName, user.name.familyName, user.primaryEmail, user.lastLoginTime, user.suspended ? 'yse' : 'no']);
            }
        } else {
            alert('No users found.');
        }
    }

    function buildRequestParams() {
        let order = document.getElementById('orderValue').value;
        let sortOrder = document.getElementById('sortOrderLink').value == true ? 'ASCENDING' : 'DESCENDING';
        let queryParam = document.getElementById('queryParam').value;
        let findType = document.getElementById('findByType').value;
        let query = queryParam ? findType + ':' + queryParam + '*' : '';

        return {
            customer: 'my_customer',
            maxResults: 500,
            orderBy: order && order != 'lastLogin' ? order : 'givenName',
            sortOrder: sortOrder,
            query: query
        };
    }
</script>

<p align="center">
<h3 align="center">Domain users utility</h3></p>

<!--Add buttons to initiate auth sequence and sign out-->
<div align="center">
    <button id="signin-button" class="btn btn-xs btn-success" style="display: none;">Sign in</button>
    <button id="signout-button" class="btn btn-xs btn-default" style="display: none;">Sign Out</button>
</div>

<br/>
<div id="content" class="container" style="display: none;">
    <table>
        <tr>
            <td>
                <div class="dropdown">
                    <label for="orderValue">Order by:</label>
                    <button id="orderValue" class="btn btn-sm btn-default dropdown" data-toggle="dropdown"
                            value="givenName"
                            aria-haspopup="true"
                            aria-expanded="true">Firstname<span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="selectOrder('givenName', this.innerHTML)">Firstname</a></li>
                        <li><a href="#" onclick="selectOrder('familyName', this.innerHTML)">Lastname</a></li>
                        <li><a href="#" onclick="selectOrder('email', this.innerHTML)">Email</a></li>
                        <li><a href="#" onclick="selectOrder('lastLogin', this.innerHTML)">Last login</a></li>
                    </ul>
                </div>
            </td>
            <td>
                <button id="sortOrderLink" value="1" onclick="this.value ^= 1; updateContent(); this.blur();"
                        class="btn btn-sm btn-link"><i class="glyphicon glyphicon-sort" style="color: #0f0f0f"></i>
                </button>
            </td>
            <td>
                <div class="dropdown">
                    <label for="findByType">Find by:</label>
                    <button id="findByType" class="btn btn-sm btn-default dropdown" data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="true">Find by <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="selectFindType('givenName', this.innerHTML)">Firstname</a></li>
                        <li><a href="#" onclick="selectFindType('familyName', this.innerHTML)">Lastname</a></li>
                        <li><a href="#" onclick="selectFindType('email', this.innerHTML)">Email</a></li>
                    </ul>
                </div>
            </td>
            <td>
                <input id="queryParam" type="text" class="form-control"/>
            </td>
            <td>
                <button id="searchBtn" class="btn btn-sm btn-default" onclick="updateContent()">Search</button>
            </td>
        </tr>
    </table>
    <br/>
    <table id="users-table" class="table table-hover">
        <thead>
        <tr>
            <th>Firstname</th>
            <th>Lastname</th>
            <th>Email</th>
            <th>Last login time</th>
            <th>Suspended</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script type="application/javascript" src="common/googleAPI.js"></script>
<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
</body>
</html>