<!DOCTYPE html>
<html>
<head>
    <title>Domain users utility</title>
    <meta charset='utf-8'/>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.js"></script>
    <link href="lib/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="custom.css" rel="stylesheet">
    <script src="lib/bootstrap/js/bootstrap.min.js"></script>
</head>
<body>

<script type="application/javascript">
    let caret = ' <span class=\'caret\'></span>';

    function changeInnerHTML(btnId, value) {
        document.getElementById(btnId).innerHTML = value + caret;
    }

    function changeElementValue(elementId, value) {
        document.getElementById(elementId).value = value;
    }

    function selectOrder(order, value) {
        let elemId = 'orderValue';

        changeInnerHTML(elemId, value);
        changeElementValue(elemId, order);
        listUsers();
    }

    function selectFindType(type, value) {
        let btnId = 'findByType';

        changeInnerHTML(btnId, value);
        changeElementValue(btnId, type);
    }

</script>

<p align="center">
<h3 align="center">Domain users utility</h3></p>

<!--Add buttons to initiate auth sequence and sign out-->
<div align="center">
    <button id="signin-button" class="btn btn-xs btn-success" style="display: none;">Sign in</button>
    <button id="signout-button" class="btn btn-xs btn-default" style="display: none;">Sign Out</button>
</div>

<br/>

<div id="content" class="container" style="display: none;">
    <table>
        <tr>
            <td>
                <div class="dropdown">
                    <label for="orderValue">Order by:</label>
                    <button id="orderValue" class="btn btn-sm btn-default dropdown" data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="true">Order by <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="selectOrder('givenName', this.innerHTML)">Firstname</a></li>
                        <li><a href="#" onclick="selectOrder('familyName', this.innerHTML)">Lastname</a></li>
                        <li><a href="#" onclick="selectOrder('email', this.innerHTML)">Email</a></li>
                        <li><a href="#" onclick="selectOrder('lastLogin', this.innerHTML)">Last login</a></li>
                    </ul>
                </div>
            </td>
            <td>
                <button id="sortOrderLink" value="1" onclick="this.value ^= 1; listUsers(); this.blur();"
                        class="btn btn-sm btn-link"><i class="glyphicon glyphicon-sort" style="color: #0f0f0f"></i>
                </button>
            </td>
            <td>
                <div class="dropdown">
                    <label for="findByType">Find by:</label>
                    <button id="findByType" class="btn btn-sm btn-default dropdown" data-toggle="dropdown"
                            aria-haspopup="true"
                            aria-expanded="true">Find by <span class="caret"></span></button>
                    <ul class="dropdown-menu">
                        <li><a href="#" onclick="selectFindType('givenName', this.innerHTML)">Firstname</a></li>
                        <li><a href="#" onclick="selectFindType('familyName', this.innerHTML)">Lastname</a></li>
                        <li><a href="#" onclick="selectFindType('email', this.innerHTML)">Email</a></li>
                    </ul>
                </div>
            </td>
            <td>
                <input id="queryParam" type="text" class="form-control"/>
            </td>
            <td>
                <button id="searchBtn" class="btn btn-sm btn-default" onclick="listUsers()">Search</button>
            </td>
        </tr>
    </table>
    <br/>
    <table id="users-table" class="table table-hover">
        <thead>
        <tr>
            <th>Firstname</th>
            <th>Lastname</th>
            <th>Email</th>
            <th>Last login time</th>
        </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
</div>

<script type="text/javascript">
    // Client ID and API key from the Developer Console
    const CLIENT_ID = '1036277936167-o2jlp8rpoumf95j3tpdcqdaarg62d3ma.apps.googleusercontent.com';

    // Array of API discovery doc URLs for APIs used by the quickstart
    const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/admin/directory_v1/rest"];

    // Authorization scopes required by the API; multiple scopes can be
    // included, separated by spaces.
    const SCOPES = 'https://www.googleapis.com/auth/admin.directory.user.readonly';

    let authorizeButton = document.getElementById('signin-button');
    let signoutButton = document.getElementById('signout-button');
    let content = document.getElementById('content');

    /**
     *  On load, called to load the auth2 library and API client library.
     */
    function handleClientLoad() {
        gapi.load('client:auth2', initClient);
    }

    /**
     *  Initializes the API client library and sets up sign-in state
     *  listeners.
     */
    function initClient() {
        gapi.client.init({
            discoveryDocs: DISCOVERY_DOCS,
            clientId: CLIENT_ID,
            scope: SCOPES,
        }).then(function () {
            // Listen for sign-in state changes.
            gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);

            // Handle the initial sign-in state.
            updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            authorizeButton.onclick = handleAuthClick;
            signoutButton.onclick = handleSignoutClick;
        });
    }

    /**
     *  Called when the signed in status changes, to update the UI
     *  appropriately. After a sign-in, the API is called.
     */
    function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
            authorizeButton.style.display = 'none';
            signoutButton.style.display = 'block';
            content.style.display = '';
            listUsers();
        } else {
            authorizeButton.style.display = 'block';
            signoutButton.style.display = 'none';
            content.style.display = 'none';
        }
    }

    /**
     *  Sign in the user upon button click.
     */
    function handleAuthClick(event) {
        gapi.auth2.getAuthInstance().signIn();
    }

    /**
     *  Sign out the user upon button click.
     */
    function handleSignoutClick(event) {
        gapi.auth2.getAuthInstance().signOut();
    }

    function appendRow(rowData) {
        let row = document.getElementById('users-table').getElementsByTagName('tbody')[0].insertRow(content.length);

        for (let data of rowData) {
            row.insertCell(row.length).innerHTML = data;
        }
    }

    function clearTable() {
        $('#users-table tbody').empty();
    }

    function compareByLastLogin(u1, u2) {
        return Math.sign(Date.parse(u1.lastLoginTime) - Date.parse(u2.lastLoginTime));
    }
    /**
     * Print users in the domain.
     */
    function listUsers() {
        let order = document.getElementById('orderValue').value;
        let sortOrder = document.getElementById('sortOrderLink').value == true ? 'ASCENDING' : 'DESCENDING';
        let queryParam = document.getElementById('queryParam').value;
        let findType = document.getElementById('findByType').value;
        let query = queryParam ? findType + ':' + queryParam + '*' : '';

        gapi.client.directory.users.list({
            customer: 'my_customer',
            maxResults: 10,
            orderBy: order && order != 'lastLogin' ? order : 'givenName',
            sortOrder: sortOrder,
            query: query
        }).then(function (response) {
            clearTable();

            let users = response.result.users;

            if (users && users.length > 0) {
                if (order == 'lastLogin') {
                    users.sort((u2, u1) => compareByLastLogin(u1, u2));

                    if (sortOrder == 'DESCENDING') {
                        users.reverse();
                    }
                }

                for (let i = 0; i < users.length; i++) {
                    let user = users[i];
                    console.log(user);
                    appendRow([user.name.givenName, user.name.familyName, user.primaryEmail, user.lastLoginTime]);
                }
            } else {
                alert('No users found.');
            }
        });
    }

</script>

<script async defer src="https://apis.google.com/js/api.js"
        onload="this.onload=function(){};handleClientLoad()"
        onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>
</body>
</html>